<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Details - InfoNest</title>
    <style>
        :root { --primary: #6c5ce7; --secondary: #a29bfe; --danger: #ff7675; --grey: #636e72; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background: #f9f9fb; }
        .container { max-width: 900px; margin: auto; }
        
        /* Header Styling */
        .club-header { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; text-align: center; }
        h1 { color: var(--primary); margin: 0; font-size: 2.5rem; }

        /* Faculty Section */
        .faculty-card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 30px; border-left: 5px solid var(--secondary); }
        .faculty-list { list-style: none; padding: 0; display: flex; gap: 15px; flex-wrap: wrap; }
        .faculty-item { background: #f1f2f6; padding: 8px 15px; border-radius: 20px; font-weight: 500; color: #2d3436; }

        /* Event Cards */
        .events-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .event-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #eee; position: relative; }
        .event-name { font-size: 1.4rem; color: #2d3436; margin-top: 0; }
        .event-desc { color: #636e72; margin-bottom: 15px; }
        .event-meta { font-size: 0.9rem; color: #b2bec3; margin-bottom: 15px; display: flex; justify-content: space-between; }
        
        .reg-count { color: var(--primary); font-weight: bold; margin-bottom: 15px; display: block; }

        /* Button Logic */
        .btn-reg { padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; width: 100%; }
        .btn-active { background: var(--primary); color: white; }
        .btn-active:hover { background: #5849d4; transform: translateY(-2px); }
        .btn-disabled { background: #dfe6e9; color: var(--grey); cursor: not-allowed; }
        
        .badge-expired { background: var(--danger); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; position: absolute; top: 15px; right: 15px; }

        .back-btn { display: inline-block; margin-bottom: 20px; text-decoration: none; color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <a href="clubdashboard.html" class="back-btn">‚Üê Back to Dashboard</a>

        <div class="club-header">
            <h1 id="clubNameDisplay">Loading Club...</h1>
            <p id="clubIdDisplay" style="color: #b2bec3;"></p>
        </div>

        <div class="faculty-card">
            <h3>Faculty Associated with this Club</h3>
            <div id="facultyList" class="faculty-list">
                </div>
        </div>

        <h2>Club Events</h2>
        <div id="eventsList" class="events-grid">
            </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. URL se club_id nikalein (using main.js helper)
            const clubId = window.InfoNest.getQueryParam('id');
            if (!clubId) {
                alert("No Club ID provided!");
                window.location.href = 'clubdashboard.html';
                return;
            }

            try {
                // 2. Aggregate Data Fetch karein
                const response = await fetch(`/api/v1/clubs/${clubId}/details`);
                if (!response.ok) throw new Error("Failed to fetch club details");
                
                const data = await response.json();

                // 3. Render Club Header
                document.getElementById('clubNameDisplay').innerText = data.club.clubName;
                document.getElementById('clubIdDisplay').innerText = `ID: ${data.club.clubId}`;

                // 4. Render Faculty List
                const facultyCont = document.getElementById('facultyList');
                if (data.faculty && data.faculty.length > 0) {
                    data.faculty.forEach(user => {
                        const span = document.createElement('span');
                        span.className = 'faculty-item';
                        span.innerText = `Prof. ${user.firstName} ${user.lastName}`;
                        facultyCont.appendChild(span);
                    });
                } else {
                    facultyCont.innerHTML = "<p>No faculty listed for this club.</p>";
                }

                // 5. Render Events with Registration Count & Deadline Logic
                const eventsCont = document.getElementById('eventsList');
                if (data.events && data.events.length > 0) {
                    const today = new Date();

                    data.events.forEach(item => {
                        const event = item.details; // Based on your API structure
                        const count = item.regCount;
                        const deadline = new Date(event.deadline);
                        const isExpired = deadline < today;

                        const card = document.createElement('div');
                        card.className = 'event-card';
                        card.innerHTML = `
                            ${isExpired ? '<span class="badge-expired">EXPIRED</span>' : ''}
                            <h3 class="event-name">${event.eventName}</h3>
                            <p class="event-desc">${event.description || "No description provided."}</p>
                            <span class="reg-count">Total Registrations: ${count}</span>
                            <div class="event-meta">
                                <span>üìÖ Date: ${event.eventDate}</span>
                                <span>‚è∞ Time: ${event.eventTime}</span>
                            </div>
                            <p class="event-meta" style="color: ${isExpired ? '#ff7675' : '#636e72'}">
                                ‚åõ Deadline: ${event.deadline}
                            </p>
                            <button 
                                class="btn-reg ${isExpired ? 'btn-disabled' : 'btn-active'}" 
                                ${isExpired ? 'disabled' : ''} 
                                onclick="handleRegisterClick('${event.eventId}', '${event.registrationFormLink}')">
                                ${isExpired ? 'Registration Closed' : 'Register Now'}
                            </button>
                        `;
                        eventsCont.appendChild(card);
                    });
                } else {
                    eventsCont.innerHTML = "<p>No events found for this club.</p>";
                }

            } catch (err) {
                console.error(err);
                document.body.innerHTML = `<h2 style='text-align:center; padding:50px;'>Error loading club data. Please try again.</h2>`;
            }
        });

        // 6. Registration Logic
        function handleRegisterClick(eventId, link) {
            // Using your existing main.js intent logic
            localStorage.setItem('savedEventId', eventId);
            localStorage.setItem('savedLink', link);

            if (!window.InfoNest.isAuthenticated()) {
                alert("Please login to register for this event.");
                window.location.href = 'login.html';
            } else {
                // If logged in, proceed to register logic from main.js or controller
                window.location.href = link === "club_form_link" ? 'club_form.html' : link;
            }
        }
    </script>
</body>
</html>